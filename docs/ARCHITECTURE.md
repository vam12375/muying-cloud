# 母婴商城微服务架构详细说明

## 📋 目录

- [架构概述](#架构概述)
- [技术选型](#技术选型)
- [服务划分](#服务划分)
- [数据库设计](#数据库设计)
- [服务治理](#服务治理)
- [安全架构](#安全架构)
- [部署架构](#部署架构)
- [监控体系](#监控体系)

## 🏗️ 架构概述

本系统采用微服务架构设计，基于Spring Boot 3.5.5和Spring Cloud 2025.0.0构建，遵循领域驱动设计(DDD)原则，实现业务功能的高内聚、低耦合。

### 核心设计原则

- **单一职责原则**: 每个微服务只负责一个业务域
- **数据独立原则**: 每个服务拥有独立的数据库
- **接口标准原则**: 统一的API设计规范和返回格式
- **故障隔离原则**: 服务间故障不相互影响
- **可观测性原则**: 完整的日志、监控、链路追踪

## 🔧 技术选型

### 基础框架层
```
Spring Boot 3.5.5      - 应用开发框架
Spring Cloud 2025.0.0  - 微服务治理框架
Java 21                - 编程语言
Maven 3.9.9           - 项目构建工具
```

### 服务治理层
```
Nacos 3.0.2           - 服务注册发现、配置管理
Spring Cloud Gateway  - API网关
OpenFeign             - 服务间调用
Sentinel 1.8.x        - 流量控制、熔断降级
Micrometer + Zipkin   - 链路追踪
```

### 数据存储层
```
MySQL 8.0.33          - 关系型数据库
MyBatis Plus 3.5.9    - ORM框架
Redis 7.x             - 缓存数据库
Elasticsearch 8.11.0  - 搜索引擎
```

### 安全认证层
```
JWT 0.12.6            - 无状态认证
Spring Security       - 安全框架
```

### 监控运维层
```
Docker                - 容器化
Docker Compose        - 容器编排
Kibana                - 日志可视化
SpringDoc OpenAPI     - 接口文档
```

## 🧩 服务划分

### 核心业务服务

#### 👤 用户服务 (muying-mall-user:8001)
**职责范围**:
- 用户注册、登录、认证
- 用户信息管理
- 用户地址管理
- 用户钱包管理
- 用户收藏管理

**技术栈**:
- Spring Boot Web
- Spring Security
- JWT认证
- MySQL + Redis
- OpenFeign

**数据模型**:
```sql
-- 核心表结构
users               用户基本信息表
user_addresses      用户地址表
user_wallets        用户钱包表
user_favorites      用户收藏表
user_login_logs     登录日志表
```

#### 🛒 商品服务 (muying-mall-product:8002)
**职责范围**:
- 商品信息管理
- 商品分类管理
- 品牌管理
- 库存管理
- 商品规格管理

**技术栈**:
- Spring Boot Web
- MySQL + Redis
- Elasticsearch集成
- 文件上传处理

**数据模型**:
```sql
-- 核心表结构
products            商品基本信息表
product_categories  商品分类表
product_brands      品牌表
product_inventories 库存表
product_specs       商品规格表
product_attributes  商品属性表
```

#### 📝 订单服务 (muying-mall-order:8003)
**职责范围**:
- 订单创建与管理
- 购物车管理
- 订单状态流转
- 订单查询统计

**技术栈**:
- Spring Boot Web
- MySQL + Redis
- 分布式事务(TCC)
- OpenFeign调用其他服务

**数据模型**:
```sql
-- 核心表结构
orders              订单主表
order_items         订单明细表
shopping_carts      购物车表
order_status_logs   订单状态变更日志表
```

#### 💰 支付服务 (muying-mall-payment:8004)
**职责范围**:
- 支付宝支付集成
- 微信支付集成
- 钱包支付
- 退款处理
- 支付流水管理

**技术栈**:
- Spring Boot Web
- MySQL + Redis
- 支付宝SDK
- 微信支付SDK
- TCC分布式事务

**数据模型**:
```sql
-- 核心表结构
payments            支付记录表
payment_methods     支付方式表
refunds            退款记录表
payment_logs       支付流水表
```

### 辅助业务服务

#### 🔍 搜索服务 (muying-mall-search:8005)
**职责范围**:
- 商品搜索
- 搜索建议
- 热门关键词
- 搜索统计分析

**技术栈**:
- Spring Boot Web
- Elasticsearch
- Redis缓存
- 数据同步机制

#### 🚛 物流服务 (muying-mall-logistics:8006)
**职责范围**:
- 物流信息管理
- 物流轨迹跟踪
- 第三方物流接入
- 配送状态同步

**技术栈**:
- Spring Boot Web
- MySQL + Redis
- 第三方物流API
- 定时任务

#### 💬 评论服务 (muying-mall-comment:8007)
**职责范围**:
- 商品评价管理
- 评价回复
- 评价标签
- 评价统计

#### 🎁 积分服务 (muying-mall-points:8008)
**职责范围**:
- 积分账户管理
- 积分规则配置
- 积分商品管理
- 积分兑换

#### ⚙️ 管理服务 (muying-mall-admin:8009)
**职责范围**:
- 后台管理
- 数据统计
- 系统配置
- 运营分析

## 🗄️ 数据库设计

### 数据库分库策略
每个微服务使用独立的数据库实例，避免服务间的数据耦合：

```yaml
数据库实例:
  user_db:      用户服务数据库
  product_db:   商品服务数据库
  order_db:     订单服务数据库
  payment_db:   支付服务数据库
  search_db:    搜索服务数据库
  logistics_db: 物流服务数据库
  comment_db:   评论服务数据库
  points_db:    积分服务数据库
  admin_db:     管理服务数据库
  nacos:        Nacos配置数据库
```

### 数据一致性保证
- **最终一致性**: 通过事件驱动架构保证数据最终一致
- **分布式事务**: 关键业务使用TCC模式保证强一致性
- **幂等性设计**: 所有接口支持幂等操作
- **补偿机制**: 提供业务补偿和回滚机制

## 🛡️ 服务治理

### 服务注册与发现
- **注册中心**: Nacos作为统一注册中心
- **健康检查**: 定期检查服务健康状态
- **负载均衡**: Spring Cloud LoadBalancer实现客户端负载均衡
- **服务路由**: 基于版本、权重等策略的灰度发布

### 配置管理
- **集中配置**: Nacos Config统一管理配置
- **动态刷新**: 支持配置热更新
- **环境隔离**: dev/test/prod环境配置隔离
- **配置加密**: 敏感配置加密存储

### 流量控制
- **限流策略**: QPS限流、并发限流、热点参数限流
- **熔断降级**: 异常比例、异常数量、RT熔断
- **系统保护**: CPU使用率、系统负载保护
- **集群流控**: 集群总体流量控制

## 🔒 安全架构

### 认证授权
```
JWT认证流程:
1. 用户登录 → 验证用户名密码
2. 生成JWT Token → 包含用户信息和权限
3. 客户端携带Token → 请求业务接口
4. 网关验证Token → 解析用户信息
5. 转发请求到后端服务 → 携带用户上下文
```

### 接口安全
- **HTTPS传输**: 生产环境强制HTTPS
- **接口签名**: 关键接口使用签名验证
- **参数校验**: 统一参数校验和SQL注入防护
- **敏感数据脱敏**: 日志和接口返回数据脱敏

### 数据安全
- **数据加密**: 敏感数据加密存储
- **访问控制**: 基于RBAC的权限控制
- **审计日志**: 完整的操作审计日志
- **数据备份**: 定期数据备份和恢复测试

## 🚀 部署架构

### 容器化部署
```yaml
# 服务容器化
每个微服务独立打包为Docker镜像:
  - 基础镜像: OpenJDK 21
  - 应用层: Spring Boot应用
  - 配置层: 外部配置文件挂载
  - 日志层: 统一日志收集

# 基础设施容器化
中间件服务:
  - MySQL: 官方MySQL 8.0镜像
  - Redis: 官方Redis 7镜像
  - Nacos: 官方Nacos镜像
  - Elasticsearch: 官方ES镜像
```

### 环境划分
- **开发环境**: 单机Docker Compose部署
- **测试环境**: Kubernetes集群部署
- **生产环境**: 高可用Kubernetes集群

### CI/CD流程
```
代码提交 → GitLab CI/CD → 
构建镜像 → 推送镜像仓库 → 
部署测试环境 → 自动化测试 → 
部署生产环境 → 健康检查
```

## 📊 监控体系

### 链路追踪
- **Zipkin**: 分布式请求链路追踪
- **Span标记**: 关键业务节点埋点
- **性能分析**: 接口响应时间分析
- **异常跟踪**: 异常请求快速定位

### 日志监控
- **统一日志**: ELK Stack日志收集分析
- **日志规范**: 统一日志格式和级别
- **实时监控**: 日志实时监控和告警
- **日志检索**: Kibana可视化日志检索

### 业务监控
- **核心指标**: QPS、响应时间、错误率
- **业务指标**: 订单量、支付成功率、用户活跃度
- **系统指标**: CPU、内存、磁盘使用率
- **告警机制**: 多渠道告警通知

### 性能监控
- **JVM监控**: 堆内存、GC、线程池监控
- **数据库监控**: 慢查询、连接池、锁等待
- **缓存监控**: Redis命中率、连接数
- **网络监控**: 带宽使用、网络延迟

## 🔄 数据流向

### 典型业务流程 - 用户下单
```
1. 用户登录认证
   客户端 → API网关 → 用户服务 → 返回JWT Token

2. 浏览商品
   客户端 → API网关 → 商品服务 → 查询商品信息
   
3. 搜索商品
   客户端 → API网关 → 搜索服务 → Elasticsearch → 返回搜索结果
   
4. 添加购物车
   客户端 → API网关 → 订单服务 → Redis缓存 → 返回成功
   
5. 提交订单
   客户端 → API网关 → 订单服务 → 
   调用商品服务(检查库存) → 
   调用用户服务(验证用户) → 
   创建订单 → MySQL → 返回订单号
   
6. 支付订单
   客户端 → API网关 → 支付服务 → 
   调用第三方支付API → 
   更新订单状态 → 
   调用库存服务(扣减库存) → 
   返回支付结果
   
7. 物流发货
   物流服务 → 定时任务 → 
   调用第三方物流API → 
   更新物流状态 → 
   推送用户通知
```

### 服务间通信
- **同步调用**: OpenFeign实现服务间RPC调用
- **异步消息**: 事件驱动架构(计划引入消息队列)
- **缓存优先**: Redis缓存热点数据
- **数据同步**: 定时任务同步数据到搜索引擎

## 🎯 架构优势

1. **高可用性**: 服务无状态设计，支持水平扩展
2. **高性能**: 多级缓存，数据库读写分离
3. **高并发**: 限流熔断，系统保护机制
4. **可维护**: 模块化设计，独立部署升级
5. **可观测**: 完整的监控和链路追踪体系
6. **安全性**: 多层次安全防护机制

## 📈 扩展性设计

### 水平扩展
- **无状态服务**: 所有微服务设计为无状态
- **负载均衡**: 支持多实例负载均衡
- **数据分片**: 支持数据库分库分表
- **缓存集群**: Redis集群模式

### 垂直扩展
- **服务拆分**: 支持进一步的服务拆分
- **功能模块**: 模块化设计便于功能扩展
- **插件机制**: 支持插件式功能扩展
- **多租户**: 支持SaaS多租户模式

## 🛠️ 技术债务与改进计划

### 待优化项
1. **消息队列**: 引入RabbitMQ或RocketMQ实现异步处理
2. **分布式事务**: 完善Seata分布式事务支持
3. **API网关**: 增强网关功能(限流、认证、协议转换)
4. **自动化测试**: 完善单元测试和集成测试
5. **性能优化**: 数据库查询优化，缓存策略优化

### 技术升级计划
1. **Spring Boot升级**: 保持与最新稳定版本同步
2. **Java版本升级**: 持续跟进Java新特性
3. **中间件升级**: 定期升级中间件版本
4. **安全加固**: 持续安全加固和漏洞修复

---

*最后更新时间: 2025-09-17*
*文档版本: v1.0*